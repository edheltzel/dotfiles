# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Overview

This is a macOS dotfiles repository using GNU Stow for symlink management and Fish shell as the primary shell. The setup is highly customized for a developer workflow with extensive keyboard-driven automation via Karabiner Elements, Raycast, and QMK/VIA firmware.

## Architecture

### Package Management with GNU Stow

The repository uses GNU Stow to create symlinks from package directories to `$HOME`. Each top-level directory (except `scripts/`, `packages/`, `macos/`, `duti/`, `private/`) is a "stow package":

- **dots/** - Miscellaneous dotfiles stored in `$HOME`
- **git/** - Git configuration (includes `.gitconfig` that sources `.gitconfig.local`)
- **fish/** - Fish shell configuration following XDG Base Directory spec
- **nvim/** - Neovim configuration (LazyVim-based, called "NEO.ED")
- **config/** - XDG config files for various applications (karabiner, raycast, starship, topgrade, yazi, etc.)
- **vscode/** - VS Code configurations (keybindings, settings)
- **zed/** - Zed editor configuration
- **local/** - User-specific data in `~/.local/`

### Key Configuration Locations

- Fish shell config: `fish/.config/fish/config.fish`
- Fish abbreviations: `fish/.config/fish/conf.d/abbr.fish`
- Fish functions: `fish/.config/fish/functions/`
- Fish paths/exports: `fish/.config/fish/conf.d/paths.fish`
- Karabiner Elements: `config/.config/karabiner/` (complex Hyper key setup)
- Topgrade config: `config/.config/topgrade.toml`

### Fish Shell Structure

- **conf.d/** - Auto-loaded configuration files:
  - `abbr.fish` - Shell abbreviations
  - `brew.fish`, `fnm.fish` - Tool integrations
  - `paths.fish` - XDG Base Directory and PATH configuration
  - `variables.fish`, `exports.fish` - Environment variables
- **functions/** - Custom functions loaded on-demand
- **fish_plugins** - Fisher plugin manager manifest (13 plugins including fzf.fish, gitnow, pisces, etc.)

### Installation Scripts

- **bootstrap.sh** - Single-line remote install script (clones repo, runs install.sh)
- **install.sh** - Main provisioning script that orchestrates the setup
- **scripts/functions.sh** - Helper functions for installation scripts
- **packages/packages.sh** - Installs from Brewfile and package manager `.txt` files
- **duti/duti.sh** - Sets default applications for file types
- **macos/macos.sh** - macOS preferences (WIP, changes with each macOS version)
- **git/git.sh** - Provisions `.gitconfig.local` for SSH signing

## Common Commands

### Stow Management (via Makefile)

```bash
make help           # Show available commands
make install        # Full bootstrap (new machine setup)
make run            # Symlink all stow packages
make stow pkg=nvim  # Symlink specific package
make unstow pkg=nvim # Remove specific package symlinks
make update         # Restow all packages (sync changes)
make delete         # Remove all stowed symlinks
```

### Alternative: Direct Stow Usage

```bash
stow nvim                # Stow specific package
stow --restow nvim       # Restow (sync) package
stow -D nvim            # Unstow (remove) package
```

### Package Management

```bash
upp                      # Alias for topgrade (updates all packages)
brew bundle --file packages/Brewfile  # Install/update Brew packages
```

### Fish Shell

```bash
reload                   # Reload fish configuration
fisher update            # Update fish plugins
```

### Development Workflow

- **Node.js**: Uses `fnm` (Fast Node Manager) for version switching
  - Supports both `.nvmrc` and `.node-version` files
  - Auto-switches on `cd` with `fnm env --use-on-cd | source`
- **Primary editors**: Neovim (NEO.ED based on LazyVim), VS Code (secondary)
- **Git signing**: SSH commit signing (preferred) over GPG
  - Config in `.gitconfig.local` (not tracked, generated by `git/git.sh`)

### Useful Fish Abbreviations

- `upp` - Update all packages via topgrade
- `lg`/`gg` - Launch lazygit
- `vim` - Alias to nvim
- `co`/`con`/`coo` - VS Code shortcuts
- `sp` - Speedtest
- `eva` - Start SSH agent and add key
- `killws` - Kill WindowServer (fixes macOS RAM leak)
- `flashEthernet` - Flush ethernet backhaul

## Special Notes

### Keyboard Customization

The setup uses a **Hyper Key** mapped to `right_cmd` + `right_shift` + `right_option` + `right_control` (right-side modifiers only). Complex chording configurations are in `config/.config/karabiner/`.

Example: `hyper + left_alt + d` opens dotfiles in default editor.

### XDG Base Directory Compliance

Fish configuration follows XDG Base Directory specification. Edit `fish/.config/fish/conf.d/paths.fish` to modify XDG variables.

### Stow Packages List

When modifying the Makefile or stow operations, the current packages are:
```makefile
STOW_PACKAGES := dots git fish nvim config vscode zed local
```

### Git Configuration

- `.gitconfig` includes `.gitconfig.local` for user-specific settings
- SSH signing is configured (see `git/git.sh` for setup)
- GPG support available but SSH preferred

### macOS-Specific

- Uses Stage Manager + Raycast + Alt-Tab for window management (formerly Aerospace)
- Ice Bar for menu bar customization (formerly Sketchybar)
- Duti for default file type associations
- Wallpapers stored at `~/.wallpapers/` (separate repo)

## Troubleshooting

### Fisher Plugin Manager

If Fisher breaks, reinstall:
```bash
curl -sL https://raw.githubusercontent.com/jorgebucaran/fisher/main/functions/fisher.fish | source && fisher install jorgebucaran/fisher
```

### SSH Agent Issues

If SSH agent doesn't persist across restarts:
```bash
eval ssh-agent -s; and ssh-add --apple-use-keychain
```

Uses `danhper/fish-ssh-agent` plugin to manage persistence.

### FNM/Node Setup

```bash
brew install fnm
fnm env --use-on-cd | source  # Enable auto-switching
npm install --global $(cat packages/node_packages.txt)  # Install global npm packages
```

### Rust/Cargo Update Issues

If cargo fails during topgrade:
```bash
brew uninstall rustup-init && brew reinstall rust && cargo uninstall cargo && cargo install cargo-update --force && topgrade --only cargo
```

### WindowServer RAM Leak

Known macOS bug with multiple external monitors:
```bash
killws  # Logs you out and restarts WindowServer
```

## Repository Structure

```
.
├── Makefile              # Stow package management
├── bootstrap.sh          # Remote install script
├── install.sh            # Main provisioning script
├── packages/
│   ├── Brewfile          # Homebrew packages (primary source)
│   ├── packages.sh       # Package installation orchestrator
│   └── *.txt             # Package lists for various managers
├── scripts/
│   └── functions.sh      # Helper functions for scripts
├── macos/                # macOS preferences (WIP)
├── duti/                 # Default file type associations
├── private/              # Private configs (empty by design)
├── dots/                 # Stow: misc dotfiles
├── git/                  # Stow: git config
├── fish/                 # Stow: fish shell
├── nvim/                 # Stow: neovim (LazyVim)
├── config/               # Stow: XDG configs
├── vscode/               # Stow: VS Code
├── zed/                  # Stow: Zed editor
└── local/                # Stow: ~/.local data
```
